name: stream-rpg-overlay

services:
  # =========================
  # DEV: hot reload (Vite)
  # =========================
  app-dev:
    image: node:20-alpine
    working_dir: /app
    profiles: ["dev"]
    environment:
      - NODE_ENV=development
      # jeśli używasz Vite i chcesz, by było dostępne z LAN/na Windows:
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    ports:
      # Vite domyślnie: 3000
      - "3000:3000"
    volumes:
      - ./:/app
      # node_modules trzymamy w kontenerze, żeby nie mieszać z Windowsem
      - app_node_modules:/app/node_modules
    command: sh -lc "npm install && npm run dev -- --host 0.0.0.0 --port 3000"

  # =========================
  # Optional: backend API (DEV)
  # jeśli nie masz backendu, usuń całą usługę
  # =========================
  api-dev:
    image: node:20-alpine
    working_dir: /app
    profiles: ["dev"]
    environment:
      - NODE_ENV=development
      - PORT=3001
    ports:
      - "3001:3001"
    volumes:
      - ./:/app
      - api_node_modules:/app/node_modules
    # ZMIEŃ jeśli backend jest w innym katalogu niż ./api
    command: sh -lc "cd api && npm install && npm run dev -- --host 0.0.0.0 --port 3001"
    # Jeśli nie masz folderu api/ — usuń tę usługę.

  # =========================
  # PROD: build + nginx
  # Wymaga Dockerfile (poniżej daję gotowca)
  # =========================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    profiles: ["prod"]
    ports:
      - "3000:3000"
    restart: unless-stopped
  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=eyJhIjoiZDEzOTBmZDZhODA1ZjYyOGEzMDYzOTMwOWUzOTk3YTMiLCJ0IjoiZmZkYWJmZTYtODhlMy00NGFkLTgzMWYtY2FmYjQzNmEzYTdlIiwicyI6IlpEUTBaV1V4T1RrdE5EYzVNUzAwTjJWbUxUbGpZamd0T0dJNFpqaG1aRFpqTnpBMCJ9
    restart: unless-stopped
    depends_on:
      - app

volumes:
  app_node_modules:
  api_node_modules:
